<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
	<meta name="viewport" content="user-scalable=no, initial-scale=1.0, maximum-scale=1.0, width=device-width">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta content="black" name="apple-mobile-web-app-status-bar-style">
	<meta name="format-detection" content="telephone=no">
	<meta content="telephone=no" name="format-detection">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<link href="assets/fontawesome/css/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <link href="assets/min/css/base.css" rel="stylesheet" type="text/css" />
	<link href="assets/min/css/widget.css" rel="stylesheet" type="text/css" />
    <link href="assets/min/css/part/register.css" rel="stylesheet" type="text/css" />
	<title>教师注册</title>
    <script type="text/javascript" src="assets/min/js/config.js"></script>
    <script type="text/javascript" src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
    <script type="text/javascript" src="assets/min/js/jquery.js"></script>
    <script type="text/javascript" src="assets/min/js/main.js?v=6"></script>
</head>
<body>
	<section class="html t-register p0 ptr ovh">
		<section class="regstep pta wp100 regstepone">
			<div class="fixed">
				<div class="t-title"><p >第(1/3)步-选择学校</p><p class="condition"></p></div>
			</div>
			<div class="forminfo adr ovh pt10 plr">
				<div class="inpntline fl wp33 pr1">
                    <p class="ovh bd-all">
                        <select class="control fs14 tint10" id="sheng">
                        </select>
                        <i class="fa fa-angle-down"></i>
                    </p>
				</div>
				<div class="inpntline fl wp33 pr1">
                    <p class="ovh bd-all">
    					<select class="control fs14 tint10" id="shi">
    					</select>
    					<i class="fa fa-angle-down"></i>
                    </p>
				</div>
				<div class="inpntline fl wp33">
                    <p class="ovh bd-all">
    					<select class="control fs14 tint10" id="qu">
    					</select>
    					<i class="fa fa-angle-down"></i>
                    </p>
				</div>
			</div>
			<section class="list p10" id="sclist">
			</section>
			<section class="sccreat forminfo hide p10" id="sccreat">
				<div class="inpntline" style="padding-top: 0px;">
					<input type="text" class="control inp bd-all" id="crename" placeholder="请输入幼儿园名称" >
					<p class="tips">如：浦江未来宝贝幼儿园&ensp;&ensp;七宝未来宝贝幼儿园</p>
				</div>
				<div class="botline botlinereg pta wp100 two b0" style="z-index:15;">
					<a class="btn bgc dsb fl alic cff b0 wp50 calnosc" href="javascript:;">取消创建</a>
					<a class="btn bgc dsb fl alic cff b0 wp50" href="javascript:;"  id="crebtn">创建并下一步</a>
				</div>
			</section>
            <p class="pta l0 b0 wp100 plr pb10 "><a class="nosc dfbtn dfbtn-pri cd bgcfff dsb alic" href="javascript:;">没有找到学校，我要创建</a></p>
			
			<!-- <div class="botline pta wp100 one b0">
				<a class="btn bg dsb fl alic cff b0 gonexttwo" href="javascript:;" data-ajax="0">下一步</a>
			</div> -->
		</section>
		<section class="regstep pta wp100 bgcf6f6f6 regsteptwo next" id="regsteptwo">
			<div class="fixed">
				<div class="t-title"><p >第(2/3)步-选择班级</p><p class="condition"></p></div>
			</div>
			<section class="classes ovh p10">
                <div class="itembox ovh p10 bgcfff ptr">
                    <p class="stil pta fs12 lh24 c66">当前学校</p>
                    <a href="javascript:;" class="gobackone change dsb pta r10 fs12 c33"><i class="fa fa-edit c33 mr5 fs16 vam"></i>更改学校</a>
                    <p class="J_selectschool fwb"></p>
                </div>
                <div class="itembox ovh p10 bgcfff ptr mt10"  id="J_classlistpanel">
                    <p class="stil pta fs12 lh24 c66">已有班级</p>
                    <div class="classlist pb10 ovh" id="classlist"></div>
                </div>
                <div class="itembox ovh p10 bgcfff ptr mt10"  id="J_newclasslistpanel">
                    <p class="stil pta fs12 lh24 c66">已有班级</p>
                    <div class="newclasslist pb10 ovh" id="newclasslist"></div>
                </div>
                <div class="itembox ovh p10 bgcfff ptr mt10">
                    <p class="stil pta fs12 lh24 c66">创建班级</p>
                    <div class="crea ptr">
                        <input type="text" class="control creainp" id="creclassname" placeholder="请输入所在班级" >
                        <input type="button" class="control btn c33 pta r0 creabtn" id="creclass" value="创建">
                    </div>
                </div>
				
			</section>
		</section>
		<section class="regstep pta wp100 bgcf6f6f6 regstepthree next" id="regstepthree">
			<div class="fixed">
				<div class="t-title"><p >最后一步-完善信息</p><p class="condition"></p></div>
			</div>
			<div class="forminfo p10">
                <div class="itembox ovh p10 bgcfff ptr">
                    <p class="stil pta fs12 lh24 c66">当前学校</p>
                    <a href="javascript:;" class="gotoone change dsb pta r10 fs12 c33"><i class="fa fa-edit c33 mr5 fs16 vam"></i>更改学校</a>
                    <p class="J_selectschool fwb"></p>
                </div>
                <div class="itembox ovh p10 bgcfff ptr mt10">
                    <p class="stil pta fs12 lh24 c66">当前班级</p>
                    <a href="javascript:;" class="gobacktwo change dsb pta r10 fs12 c33"><i class="fa fa-edit c33 mr5 fs16 vam"></i>更改班级</a>
                    <p class="J_selectclass fwb"></p>
                </div>
                <div class="itembox ovh p10 bgcfff ptr mt10">
                    <p class="stil pta fs12 lh24 c66">个人信息</p>
                    <div class="inpntline">
                        <input class="controla" id="nickname" type="text" placeholder="请输入您在幼儿园的称呼">
                        <p class="rtip-red">必填</p>
                        <p class="tips">如：小雨老师&ensp;&ensp;田田姐</p>
                    </div>
                    <div class="pt10">
                        <label class="radio"><input type="radio" name="sex" value="0" checked><span></span>女</label>
                        <label class="radio"><input type="radio" name="sex" value="1"><span></span>男</label>
                    </div>
                    <br>
                </div>
			</div>
			<div class="pta b0 wp100 p10">
				<a class="btn bgc dsb fl alic cff b0 wp100 bdr20 finish" href="javascript:;">确认并提交</a>
			</div>
		</section>
		<section class="tcover ptf wp100 hp100 l0 t0 p10 hide" id="tcover">
			<p class="title cd fs24 alic">注册成功</p>
			<p class="text pb10">您已成功创建学校和班级，您可进入个人中心完善信息或查看功能。</p>
			<!-- <p class="text pb10">您可邀请老师或家长加入班级</p> -->
			<a href="index1.html"  class="enter cd dsb wp100 fs14 alic bd-all bgcfff pta lp50 b0 bdr20">注册完成</a>
		</section>
	</section>
    <script type="text/javascript" src="assets/min/js/area.js"></script>
    <script type="text/javascript">
        ;(function ($, window, document, undefined) {
            var tRegisterPage = (function () {
                return {
                    _sid: '',
                    _sname: '',
                    _classid: '',
                    _classname: '',
                    _gloConfig: window.globalConfig,
                    _sclist: $('#sclist'),
                    _regsteptwo: $("#regsteptwo"),
                    _regstepthree: $('#regstepthree'),
                    _classlist: $("#classlist"),
                    _newclasslist: $("#newclasslist"),
                    _sccreat: $("#sccreat"),
                    _getRequest: function(){
                        var url = window.location.search,
                                theRequest = {},
                                str = '',
                                para = [];
                        if (url.indexOf("?") != -1) {
                            str = url.substr(1);
                            strs = str.split("&");
                            for(var i = 0, len = strs.length; i < len; i ++) {
                                para = strs[i].split("=");
                                //decodeURI()、decodeURIComponent
                                theRequest[para[0]] = decodeURIComponent( (para.length>=2)?para[1]:"");
                            }
                        }
                        return theRequest;
                    },
                    _tipshow: function(options) {
                        var msg = options.msg;
                        var type = options.type ? options.type : 'info';
                        var ico = options.ico ? options.ico : 'info-circle';
                        var str = '<div class="tippop ptf z10 fs12 wp100 alic"><div class="dsilb fs12 text ' + type + '"><i class="fa fa-' + ico + '"></i>' + msg + '</div></div>';
                        var pop = $('body').append(str).find('.tippop');
                        //$('body').append(str);
                        //var pop = $('.tippop');
                        setTimeout(function() {
                            pop.animate({
                                'opacity': 0
                            }, 600, function() {
                                pop.remove();
                                if (options.callback) {
                                    options.callback();
                                }
                            });
                        }, 1500);
                    },
                    _setInfo: function(schoolName, className) {
                        var selectschool = $(".J_selectschool"),
                            selectclass = $(".J_selectclass");
                        if(schoolName !== null){
                            schoolName = schoolName || "";
                            selectschool.text(decodeURIComponent(schoolName));
                        }
                        if(className !== null){
                            className = className || "";
                            selectclass.text(decodeURIComponent(className));
                        }
                    },
                    _showTwoStep: function(){
                        this._setInfo(this._sclist.find(".scls.active p.n").text(), null);
                        this._regsteptwo.animate({"top": 0});
                    },
                    _showThreeStep: function(top){
                        var className = "";
                        if(this._sid){
                            className = this._classlist.find(".csls.active p.n").text();
                        }else{
                            className = this._newclasslist.find(".csls.active p.n").text();
                        }
                        this._setInfo(null, className);
                        this._regstepthree.animate({"top": (top || 0)});
                    },
                    _getClassList: function(schoolid, classid, elem, callback){
                        var _this = this, classid = classid || "";
                        $.ajax({
                            scope: _this,
                            type: "GET",
                            url:  _this._gloConfig.urlPrefix+"/crm/class/list/"+schoolid,
                            dataType: "json",
                            "processData": true,
                            "xhrFields": {
                                withCredentials: true
                            },
                            success: function(res, textStatus, jqXHR) {
                                if(res.code !== 0){
                                    return false;
                                }
                                var str="", ac;
                                for(var i= 0, data=res.data, len=data.length; i<len;i++){
                                    ac = '';
                                    if(data[i]["_id"] === +classid) {
                                        ac = "active";
                                    }
                                    str += '<div class="csls fl alic '+ac+'" data-classid="'+data[i]["_id"]+'"><a href="javascript:;" class="dsb c33 pt5 pb5"><p class="n ellipsis">'+data[i]["title"]+'</p><p class="cn fs12">'+(data[i]["creater"] && data[i]["creater"]["name"] || "")+'</p></a></div>';
                                }
                                _this._classlist.html(str)
                                callback && callback.call(null);
                                elem &&  elem.data('ajax', 1);
                            }
                        });

                    },
                    renderData: function(){
                        var _gsheng = 44,
                            _gshi = 45,
                            _gqu = 55,
                            _this = this,
                            $winh = window.innerHeight,
                            $winw = window.innerWidth;
                        $('.regstep, .t-register').css('height',$winh);
                        _this._sclist.css('height', $winh-160);
                        //选择地址
                        window.showLocation(_gsheng, _gshi, _gqu, '#sheng','#shi','#qu');
                        //获取url中的参数
                        var tickets = ((_this._getRequest() ||"")["ticket"]||"").split("_");
                        if(+tickets[0]) this._sid = +tickets[0];
                        if(+tickets[1]) this._classid = +tickets[1];
                        //获取school列表数据
                        $.ajax({
                            scope: _this,
                            type: "GET",
                            url: _this._gloConfig.urlPrefix+"/crm/kg/list",
                            dataType: "json",
                            "processData": true,
                            "xhrFields": {
                                withCredentials: true
                            },
                            success: function(res, textStatus, jqXHR) {
                                var str="", namearr=[], ac;
                                if(res.code !== 0){
                                    return false;
                                }
                                for(var i= 0, data= res.data, len = data.length; i < len;  i++){
                                    namearr.push(data[i].name);
                                    //带参数的url初始化school列表
                                    ac = "";
                                    if(_this._sid === data[i]["_id"]){
                                        ac = "active";
                                    }
                                    str += '<a href="javascript:;" data-sid="'+data[i]["_id"]+'" class="scls mt1 bgcfff p10 dsb c33 ptr '+ac+'" ><p class="n fwb">'+data[i]["title"]+'</p><i class="fa fa-check cd pta r10 dsn"></i></a>';
                                }
                                _this._sclist.append(str);
                            }
                        });
                        //带参数的url初始化class列表
                        if(_this._sid){
                            _this._getClassList(_this._sid, _this._classid, null);
                            _this._setInfo(tickets[2] || "", tickets[3] || "");
                            _this._regsteptwo.css("top","0px");
                            _this._regstepthree.css("top","0px");
                        }

                    },
                    bindEvent:function(){
                        var _this = this,
                            $winh = window.innerHeight,
                            $winw = window.innerWidth,
                            classlistpanel = $("#J_classlistpanel"),
                            newclasslistpanel = $("#J_newclasslistpanel");

                        var seleClass = function(){
                            var $this = $(this);
                            $this.addClass('active').siblings().removeClass('active');
                            _this._classid = $this.data("classid");
                            _this._showThreeStep.call(_this, 0);
                        };
                        //选择已有班级
                        this._classlist.on('click','.csls', seleClass);
                        this._newclasslist.on('click','.csls', seleClass);
                        //选择学校
                        _this._sclist.on('click','.scls', function(){
                            var $this = $(this);
                            $this.addClass('active').siblings().removeClass('active');
                            //var active = _this._sclist.find('.active');
                            var sid = $this.data('sid');
                            if(sid){
                                _this._getClassList(sid, null, $this, function(){
                                    //选择性显示已有班级
                                    classlistpanel.show();
                                    newclasslistpanel.hide();
                                    //
                                    _this._sid = sid;
                                    _this._showTwoStep();
                                }.bind(this));
                            }else{
                                //选择性显示已有班级
                                classlistpanel.hide();
                                newclasslistpanel.show();
                                //
                                _this._showTwoStep();
                            }
                        });
                        //

                        $('.nosc').on('click',function(){
                            var gsheng = $('#sheng').val();
                            var gshi = $('#shi').val();
                            var gqu = $('#qu').val();
                            if(gsheng=="0"){
                                _this._tipshow({"msg":"请选择省份","type":"waring","ico":"times"});
                                return false;
                            }else if(gshi=='0'){
                                _this._tipshow({"msg":"请选择城市","type":"waring","ico":"times"});
                                return false;
                            }else if(gqu=='0'){
                                _this._tipshow({"msg":"请选择区/县","type":"waring","ico":"times"});
                                return false;
                            }
                            _this._sclist.hide();
                            _this._sccreat.show();
                            $(this).hide();
                            _this._sclist.find('.active').removeClass('active');
                        })
                        //
                        $('.calnosc').on('click',function(){
                            $('.nosc').show();
                            _this._sclist.show();
                            _this._sccreat.hide();
                        })
                        //创建学校
                        $('#crebtn').on('click',function(){
                            var gsheng = $('#sheng').val();
                            var gshi = $('#shi').val();
                            var gqu = $('#qu').val();
                            if(gsheng=="0"){
                                _this._tipshow({"msg":"请选择省份","type":"waring","ico":"times"});
                                return false;
                            }else if(gshi=='0'){
                                _this._tipshow({"msg":"请选择城市","type":"waring","ico":"times"});
                                return false;
                            }else if(gqu=='0'){
                                _this._tipshow({"msg":"请选择区/县","type":"waring","ico":"times"});
                                return false;
                            }
                            var name = $('#crename').val().replace(/\s/ig,'');
                            if(name.length == 0){
                                _this._tipshow({"msg":"请输入学校名称","type":"waring","ico":"times"});
                                return false;
                            }
                            $('.nosc').show();
                            //选择性显示已有班级
                            classlistpanel.hide();
                            newclasslistpanel.hide();
                            //
                            _this._sccreat.hide();
                            _this._sclist.append('<a href="javascript:;" data-sid="" class="active scls mt1 bgcfff p10 dsb c33 ptr"><p class="n fwb">'+name+'</p><i class="fa fa-check cd pta r10 dsn"></i></a>').show();
                            _this._showTwoStep();
                            _this._sname = name;
                            _this._sid = null;
                        });
                        //创建班级
                        $("#creclass").on('click',function(){
                            var creclassname = $('#creclassname');
                            var name = creclassname.val().replace(/\s/ig,'');
                            if(name.length==0){
                                _this._tipshow({"msg":"请输入班级名称","type":"waring","ico":"times"});
                                return false;
                            }
                            //
                            _this._classlist.find('.active').removeClass('active');
                            _this._newclasslist.find('.active').removeClass('active');
                            if(_this._sid){
                                _this._classlist.append('<div class="csls fl alic active"  data-classid="" data-classname="'+name+'"><a href="javascript:;" class="dsb  c33 pt5 pb5"><p class="n ellipsis">'+name+'</p><p class="cn fs12">我</p></a></div>');
                                //选择性显示已有班级
                                classlistpanel.show();
                                newclasslistpanel.hide();
                            }else{
                                _this._newclasslist.append('<div class="csls fl alic active"  data-classid="" data-classname="'+name+'"><a href="javascript:;" class="dsb c33 pt5 pb5"><p class="n ellipsis">'+name+'</p><p class="cn fs12">我</p></a></div>');
                                //选择性显示已有班级
                                classlistpanel.hide();
                                newclasslistpanel.show();
                            }
                            creclassname.val('');
                            _this._classname = name;
                            _this._classid = null;
                            //下一步
                            _this._showThreeStep(0);
                        });
                        //
                        $('.html').on('click','.gobackone',function(){
                            _this._classlist.html("");
                            _this._newclasslist.html("");
                            _this._regsteptwo.animate({'top':$winh});
                        }).on('click','.gonextthree',function(){
                        }).on('click','.gobacktwo',function(){
                            //选择性显示已有班级
                            classlistpanel.show();
                            newclasslistpanel.hide();
                            //隐藏第三步
                            _this._showThreeStep($winh);
                        }).on('click','.gotoone',function(){
                            _this._regsteptwo.css({'top':$winh});
                            _this._showThreeStep($winh);
                        }).on('click','.finish',function(){
                            var nickname = $('#nickname').val().replace(/\s/ig,'');
                            var sex = +($('input[name="sex"]:checked').val());
                            if(nickname.length === 0){
                                _this._tipshow({"msg":"称呼不可为空","type":"waring","ico":"times"});
                                return false;
                            }
                            if([0,1].indexOf(sex) < 0){
                                _this._tipshow({"msg":"性别不可为空","type":"waring","ico":"times"});
                                return false;
                            }
                            var gsheng = $('#sheng').val();
                            var gshi = $('#shi').val();
                            var gqu = $('#qu').val();
                            var dataStr = JSON.stringify({
                                "data":{
                                    "name": nickname,
                                    "sex": sex,
                                    "kg_id": _this._sid,
                                    "class_id": _this._classid,
                                    "create": {
                                        "kg": {
                                            "district_code": gsheng+"_"+gshi+"_"+gshi,
                                            "title": _this._sname
                                        },
                                        "class": {
                                            "title": _this._classname
                                        }
                                    }
                                }
                            });
                            $.ajax({
                                scope: _this,
                                type: "POST",
                                url: _this._gloConfig.urlPrefix+"/crm/teacher/register",
                                dataType: 'json',
                                contentType: "application/json",
                                "processData": true,
                                "xhrFields": {
                                    withCredentials: true
                                },
                                data: dataStr,
                                success: function(res, textStatus, jqXHR) {
                                    if(res.code !== 0){
                                        return false;
                                    }
                                    window.localStorage.setItem("first",'1');
                                    $('#tcover').show();
                                }
                            });
                        })
                    },
                    init: function(){
                        this.renderData();
                        this.bindEvent();
                    }
                };
            })();
            $(function(){
                tRegisterPage.init();
            });
        })(jQuery, window, document);
    </script>
</body>
</html>
